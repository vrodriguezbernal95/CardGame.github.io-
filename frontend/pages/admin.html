<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Card Game Anime</title>
    <link rel="stylesheet" href="../css/global.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box h3 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-box p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--primary-color);
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .tab:hover {
            background: #f3f4f6;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .partida-pendiente {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .partida-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .partida-info {
            flex: 1;
        }

        .partida-actions {
            display: flex;
            gap: 0.5rem;
        }

        .badge-pendiente {
            background: #ffc107;
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .migrar-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .migrar-btn:hover {
            background: #ee5a5a;
        }
    </style>
</head>
<body>
    <!-- Header Principal -->
    <header class="header-main">
        <div class="header-main-container">
            <div class="nav-brand">üé¥ Card Game Anime</div>
            <div id="user-nav"></div>
        </div>
    </header>

    <!-- Header Navegaci√≥n -->
    <nav class="header-nav">
        <div class="header-nav-container">
            <ul class="nav-links">
                <li><a href="historial.html">Historial</a></li>
                <li><a href="estadisticas.html">Estad√≠sticas</a></li>
                <li><a href="mazos.html">Mazos</a></li>
                <li><a href="combate.html">Registrar Combate</a></li>
                <li><a href="contador.html">Contador</a></li>
                <li><a href="compartir.html">üì§ Compartir</a></li>
                <li><a href="admin.html">Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">‚öôÔ∏è Panel de Administraci√≥n</h1>
                <p class="card-subtitle">Gestiona partidas, usuarios y aprobaciones</p>
            </div>

            <!-- Dashboard Resumen -->
            <div id="dashboard-resumen" class="dashboard-grid">
                <div class="stat-box">
                    <h3 id="total-pendientes">-</h3>
                    <p>Partidas Pendientes</p>
                </div>
                <div class="stat-box">
                    <h3 id="total-aprobadas">-</h3>
                    <p>Partidas Aprobadas</p>
                </div>
                <div class="stat-box">
                    <h3 id="total-usuarios">-</h3>
                    <p>Usuarios Registrados</p>
                </div>
                <div class="stat-box">
                    <h3 id="total-mazos">-</h3>
                    <p>Mazos Disponibles</p>
                </div>
            </div>

            <!-- Alerta de migraci√≥n (si es necesario) -->
            <div id="migracion-alert">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Migraci√≥n del Sistema de Aprobaci√≥n</strong>
                    <p>Si registrar combates da error 500, ejecuta esta migraci√≥n una vez (crea tablas necesarias en la base de datos).</p>
                    <button onclick="ejecutarMigracion()" class="migrar-btn">
                        ‚öôÔ∏è Ejecutar Migraci√≥n Ahora
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('pendientes')">
                    üìù Partidas Pendientes <span id="badge-pendientes" class="badge badge-warning" style="margin-left: 0.5rem;">0</span>
                </button>
                <button class="tab" onclick="cambiarTab('agregar')">‚öîÔ∏è A√±adir Partida</button>
                <button class="tab" onclick="cambiarTab('usuarios')">üë• Usuarios</button>
                <button class="tab" onclick="cambiarTab('mazos')">üé¥ Mazos</button>
            </div>

            <!-- Tab: Partidas Pendientes -->
            <div id="tab-pendientes" class="tab-content active">
                <div id="partidas-pendientes-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="mt-2">Cargando partidas pendientes...</p>
                    </div>
                </div>
            </div>

            <!-- Tab: A√±adir Partida -->
            <div id="tab-agregar" class="tab-content">
                <h3 style="margin-bottom: 1.5rem;">‚ûï Registrar Partida Manualmente</h3>
                <form id="form-partida" style="max-width: 600px;">
                    <div class="form-group">
                        <label class="form-label">Jugador 1</label>
                        <select id="jugador1" class="form-control" required>
                            <option value="">Selecciona jugador 1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mazo Jugador 1</label>
                        <select id="mazo1" class="form-control" required>
                            <option value="">Selecciona mazo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jugador 2</label>
                        <select id="jugador2" class="form-control" required>
                            <option value="">Selecciona jugador 2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mazo Jugador 2</label>
                        <select id="mazo2" class="form-control" required>
                            <option value="">Selecciona mazo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Resultado</label>
                        <select id="resultado" class="form-control" required>
                            <option value="">Selecciona resultado</option>
                            <option value="victoria_jugador1">Victoria Jugador 1</option>
                            <option value="victoria_jugador2">Victoria Jugador 2</option>
                            <option value="empate">Empate</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha del Combate</label>
                        <input type="date" id="fecha-partida" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notas (opcional)</label>
                        <textarea id="notas-partida" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">A√±adir Partida</button>
                </form>

                <hr style="margin: 3rem 0; border: none; border-top: 2px solid var(--border);">

                <h3 style="margin-bottom: 1.5rem;">üóëÔ∏è Gestionar Partidas Existentes</h3>

                <div class="form-group" style="max-width: 400px; margin-bottom: 1.5rem;">
                    <input
                        type="text"
                        id="buscar-partida"
                        class="form-control"
                        placeholder="üîç Buscar por jugador o mazo..."
                        style="padding-left: 1rem;"
                    >
                </div>

                <div id="partidas-lista-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="mt-2">Cargando partidas...</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Usuarios -->
            <div id="tab-usuarios" class="tab-content">
                <h3 style="margin-bottom: 1.5rem;">‚ûï Crear Nuevo Usuario</h3>
                <form id="form-usuario" style="max-width: 600px; margin-bottom: 3rem;">
                    <div class="form-group">
                        <label class="form-label">Nombre</label>
                        <input type="text" id="usuario-nombre" class="form-control" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="usuario-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" id="usuario-password" class="form-control" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="usuario-admin">
                            <span>Es Administrador</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Crear Usuario</button>
                </form>

                <h3 style="margin-bottom: 1.5rem;">üë• Lista de Usuarios</h3>

                <div class="form-group" style="max-width: 400px; margin-bottom: 1.5rem;">
                    <input
                        type="text"
                        id="buscar-usuario"
                        class="form-control"
                        placeholder="üîç Buscar por nombre o email..."
                        style="padding-left: 1rem;"
                    >
                </div>

                <div id="usuarios-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="mt-2">Cargando usuarios...</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Mazos -->
            <div id="tab-mazos" class="tab-content">
                <h3 style="margin-bottom: 1.5rem;">‚ûï Crear Nuevo Mazo</h3>
                <form id="form-mazo" style="max-width: 600px; margin-bottom: 3rem;">
                    <div class="form-group">
                        <label class="form-label">Nombre del Mazo</label>
                        <input type="text" id="mazo-nombre" class="form-control" required placeholder="Ej: Piratas del Sombrero de Paja">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Serie</label>
                        <input type="text" id="mazo-serie" class="form-control" required placeholder="Ej: One Piece">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea id="mazo-descripcion" class="form-control" rows="3" required placeholder="Describe la estrategia del mazo..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Crear Mazo</button>
                </form>

                <h3 style="margin-bottom: 1.5rem;">üìã Mazos Existentes</h3>
                <div id="mazos-lista-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="mt-2">Cargando mazos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar mazo -->
    <div id="modal-editar-mazo" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:2rem; border-radius:12px; max-width:500px; width:90%;">
            <h3 style="margin-bottom:1.5rem;">‚úèÔ∏è Editar Mazo</h3>
            <form id="form-editar-mazo">
                <input type="hidden" id="edit-mazo-id">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" id="edit-mazo-nombre" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Serie</label>
                    <input type="text" id="edit-mazo-serie" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea id="edit-mazo-descripcion" class="form-control" rows="3" required></textarea>
                </div>
                <div style="display:flex; gap:1rem; justify-content:flex-end;">
                    <button type="button" onclick="cerrarModalEditar()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // Verificar que es admin
        if (!checkAuth(true)) {
            // Redirige autom√°ticamente si no es admin
        }

        // Cambiar tabs
        function cambiarTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            document.getElementById(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');

            if (tab === 'pendientes') cargarPartidasPendientes();
            if (tab === 'agregar') cargarPartidasLista();
            if (tab === 'usuarios') cargarUsuarios();
            if (tab === 'mazos') cargarMazos();
        }

        // Cargar resumen del dashboard
        async function cargarResumen() {
            try {
                const [pendientes, partidas, usuarios, mazos] = await Promise.all([
                    API.getPartidasPendientes(),
                    API.getPartidas(),
                    API.getUsuarios(),
                    API.getMazos()
                ]);

                document.getElementById('total-pendientes').textContent = pendientes.total || 0;
                document.getElementById('total-aprobadas').textContent = partidas.partidas?.length || 0;
                document.getElementById('total-usuarios').textContent = usuarios.usuarios?.length || 0;
                document.getElementById('total-mazos').textContent = mazos.mazos?.length || 0;

                document.getElementById('badge-pendientes').textContent = pendientes.total || 0;

            } catch (error) {
                console.error('Error cargando resumen:', error);
            }
        }

        // Cargar partidas pendientes
        async function cargarPartidasPendientes() {
            const container = document.getElementById('partidas-pendientes-container');

            try {
                const result = await API.getPartidasPendientes();

                // Si carga bien, ocultar el bot√≥n de migraci√≥n
                document.getElementById('migracion-alert').style.display = 'none';

                if (!result.success || result.partidas.length === 0) {
                    container.innerHTML = `
                        <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                            ‚úÖ No hay partidas pendientes de aprobaci√≥n
                        </p>
                    `;
                    // Actualizar badge
                    document.getElementById('badge-pendientes').textContent = '0';
                    return;
                }

                // Actualizar badge con el n√∫mero de pendientes
                document.getElementById('badge-pendientes').textContent = result.partidas.length;

                let html = '';
                result.partidas.forEach(p => {
                    const fecha = UI.formatDate(p.fecha_partida);
                    html += `
                        <div class="partida-pendiente">
                            <div class="partida-header">
                                <div class="partida-info">
                                    <div style="margin-bottom: 0.5rem;">
                                        <span class="badge-pendiente">PENDIENTE</span>
                                        <small style="margin-left: 0.5rem; color: var(--text-secondary);">${fecha}</small>
                                    </div>
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                        ${p.jugador1_nombre} (${p.mazo1_nombre}) vs ${p.jugador2_nombre} (${p.mazo2_nombre})
                                    </div>
                                    <div>
                                        <span class="badge ${UI.getBadgeClass(p.resultado)}">${UI.formatResultado(p.resultado)}</span>
                                        ${p.ganador_nombre ? `<span style="margin-left: 0.5rem;">Ganador: <strong>${p.ganador_nombre}</strong></span>` : ''}
                                    </div>
                                    ${p.registrado_por ? `<small style="color: var(--text-secondary);">Registrado por: ${p.registrado_por}</small>` : ''}
                                    ${p.notas ? `<p style="margin-top: 0.5rem; font-style: italic;">üìù ${p.notas}</p>` : ''}
                                </div>
                                <div class="partida-actions">
                                    <button onclick="aprobarPartida(${p.id})" class="btn btn-success btn-sm">
                                        ‚úÖ Aprobar
                                    </button>
                                    <button onclick="rechazarPartida(${p.id})" class="btn btn-error btn-sm">
                                        ‚ùå Rechazar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                // Si error 500, probablemente necesita migraci√≥n
                if (error.message.includes('estado')) {
                    document.getElementById('migracion-alert').style.display = 'block';
                }
                container.innerHTML = `
                    <div class="alert alert-error">
                        Error al cargar partidas pendientes: ${error.message}
                    </div>
                `;
            }
        }

        // Aprobar partida
        async function aprobarPartida(id) {
            if (!confirm('¬øAprobar esta partida?')) return;

            try {
                const result = await API.aprobarPartida(id);
                if (result.success) {
                    UI.showAlert('Partida aprobada exitosamente', 'success');
                    cargarPartidasPendientes();
                    cargarResumen();
                }
            } catch (error) {
                UI.showAlert('Error al aprobar partida: ' + error.message, 'error');
            }
        }

        // Rechazar partida
        async function rechazarPartida(id) {
            if (!confirm('¬øRechazar esta partida? Esta acci√≥n no se puede deshacer.')) return;

            try {
                const result = await API.rechazarPartida(id);
                if (result.success) {
                    UI.showAlert('Partida rechazada', 'success');
                    cargarPartidasPendientes();
                    cargarResumen();
                }
            } catch (error) {
                UI.showAlert('Error al rechazar partida: ' + error.message, 'error');
            }
        }

        // Ejecutar migraci√≥n
        async function ejecutarMigracion() {
            if (!confirm('¬øEjecutar migraci√≥n del sistema de aprobaci√≥n? Esto modificar√° la base de datos.')) return;

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Ejecutando migraci√≥n...';

            try {
                const result = await API.ejecutarMigracion();
                if (result.success) {
                    UI.showAlert('Migraci√≥n ejecutada exitosamente', 'success');
                    document.getElementById('migracion-alert').style.display = 'none';
                    setTimeout(() => location.reload(), 1500);
                }
            } catch (error) {
                UI.showAlert('Error en migraci√≥n: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Ejecutar Migraci√≥n Ahora';
            }
        }

        // Cargar selectores
        async function cargarSelectores() {
            try {
                const [usuarios, mazos] = await Promise.all([
                    API.getUsuarios(),
                    API.getMazos()
                ]);

                // Llenar selectores de jugadores
                const selectsJugadores = ['jugador1', 'jugador2'];
                selectsJugadores.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    usuarios.usuarios.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.id;
                        option.textContent = u.nombre;
                        select.appendChild(option);
                    });
                });

                // Llenar selectores de mazos
                const selectsMazos = ['mazo1', 'mazo2'];
                selectsMazos.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    mazos.mazos.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = `${m.nombre} (${m.serie})`;
                        select.appendChild(option);
                    });
                });

            } catch (error) {
                console.error('Error cargando selectores:', error);
            }
        }

        // Form a√±adir partida
        document.getElementById('form-partida').addEventListener('submit', async (e) => {
            e.preventDefault();

            const partidaData = {
                jugador1_id: parseInt(document.getElementById('jugador1').value),
                jugador2_id: parseInt(document.getElementById('jugador2').value),
                mazo1_id: parseInt(document.getElementById('mazo1').value),
                mazo2_id: parseInt(document.getElementById('mazo2').value),
                resultado: document.getElementById('resultado').value,
                fecha_partida: document.getElementById('fecha-partida').value,
                notas: document.getElementById('notas-partida').value.trim() || null
            };

            try {
                const result = await API.createPartida(partidaData);
                if (result.success) {
                    UI.showAlert('Partida a√±adida exitosamente', 'success');
                    e.target.reset();
                    // Restablecer fecha a hoy
                    const hoy = new Date().toISOString().split('T')[0];
                    document.getElementById('fecha-partida').value = hoy;
                    cargarResumen();
                    cargarPartidasLista();
                }
            } catch (error) {
                UI.showAlert('Error al a√±adir partida: ' + error.message, 'error');
            }
        });

        // Variables globales para usuarios
        let todosLosUsuarios = [];

        // Cargar usuarios
        async function cargarUsuarios() {
            const container = document.getElementById('usuarios-container');

            try {
                const result = await API.getUsuarios();

                if (!result.success || result.usuarios.length === 0) {
                    container.innerHTML = '<p class="text-center">No hay usuarios</p>';
                    todosLosUsuarios = [];
                    return;
                }

                todosLosUsuarios = result.usuarios;
                renderizarUsuarios(todosLosUsuarios);

            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        // Renderizar tabla de usuarios
        function renderizarUsuarios(usuarios) {
            const container = document.getElementById('usuarios-container');

            if (usuarios.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">No se encontraron usuarios</p>';
                return;
            }

            const currentUserId = API.getUser().id;

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Admin</th>
                            <th>Fecha Registro</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            usuarios.forEach(u => {
                const isCurrentUser = u.id === currentUserId;
                html += `
                    <tr>
                        <td>${u.id}</td>
                        <td><strong>${u.nombre}</strong>${isCurrentUser ? ' <span class="badge badge-info">T√ö</span>' : ''}</td>
                        <td>${u.email}</td>
                        <td>${u.es_admin ? '<span class="badge badge-success">S√ç</span>' : '<span class="badge badge-secondary">NO</span>'}</td>
                        <td>${u.fecha_creacion ? new Date(u.fecha_creacion).toLocaleDateString() : '-'}</td>
                        <td>
                            ${isCurrentUser
                                ? '<span style="color: #999; font-size: 0.9rem;">-</span>'
                                : `<button onclick="eliminarUsuario(${u.id}, '${u.nombre.replace(/'/g, "\\'")}' )" class="btn btn-error btn-sm">üóëÔ∏è Eliminar</button>`
                            }
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Filtrar usuarios
        document.getElementById('buscar-usuario').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();

            if (query === '') {
                renderizarUsuarios(todosLosUsuarios);
                return;
            }

            const usuariosFiltrados = todosLosUsuarios.filter(u =>
                u.nombre.toLowerCase().includes(query) ||
                u.email.toLowerCase().includes(query)
            );

            renderizarUsuarios(usuariosFiltrados);
        });

        // Form crear usuario
        document.getElementById('form-usuario').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userData = {
                nombre: document.getElementById('usuario-nombre').value.trim(),
                email: document.getElementById('usuario-email').value.trim(),
                password: document.getElementById('usuario-password').value,
                es_admin: document.getElementById('usuario-admin').checked
            };

            try {
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.textContent = 'Creando...';

                const result = await API.createUser(userData);
                if (result.success) {
                    UI.showAlert('Usuario creado exitosamente', 'success');
                    e.target.reset();
                    cargarUsuarios();
                    cargarResumen();
                }

                btn.disabled = false;
                btn.textContent = 'Crear Usuario';
            } catch (error) {
                UI.showAlert('Error al crear usuario: ' + error.message, 'error');
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = false;
                btn.textContent = 'Crear Usuario';
            }
        });

        // Eliminar usuario
        async function eliminarUsuario(id, nombre) {
            if (!confirm(`¬øEliminar al usuario "${nombre}"?\n\nNOTA: No se puede eliminar si tiene partidas asociadas.`)) return;

            try {
                const result = await API.deleteUser(id);
                if (result.success) {
                    UI.showAlert('Usuario eliminado exitosamente', 'success');
                    cargarUsuarios();
                    cargarResumen();
                }
            } catch (error) {
                UI.showAlert('Error al eliminar usuario: ' + error.message, 'error');
            }
        }

        // ========== GESTI√ìN DE MAZOS ==========

        // Cargar mazos
        async function cargarMazos() {
            const container = document.getElementById('mazos-lista-container');

            try {
                const result = await API.getMazos();

                if (!result.success || result.mazos.length === 0) {
                    container.innerHTML = '<p class="text-center">No hay mazos creados</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 1rem;">';

                result.mazos.forEach(m => {
                    html += `
                        <div style="background: white; border: 2px solid var(--primary-color); border-radius: 8px; padding: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">${m.nombre}</h4>
                                    <span class="badge badge-info">${m.serie}</span>
                                    <p style="color: var(--text-secondary); margin-top: 0.75rem;">${m.descripcion}</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                    <button onclick="abrirModalEditar(${m.id}, '${m.nombre.replace(/'/g, "\\'")}', '${m.serie.replace(/'/g, "\\'")}', '${m.descripcion.replace(/'/g, "\\'")}' )" class="btn btn-primary btn-sm">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button onclick="eliminarMazo(${m.id}, '${m.nombre.replace(/'/g, "\\'")}' )" class="btn btn-error btn-sm">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        // Form crear mazo
        document.getElementById('form-mazo').addEventListener('submit', async (e) => {
            e.preventDefault();

            const mazoData = {
                nombre: document.getElementById('mazo-nombre').value.trim(),
                serie: document.getElementById('mazo-serie').value.trim(),
                descripcion: document.getElementById('mazo-descripcion').value.trim()
            };

            try {
                const result = await API.createMazo(mazoData);
                if (result.success) {
                    UI.showAlert('Mazo creado exitosamente', 'success');
                    e.target.reset();
                    cargarMazos();
                    cargarResumen();
                }
            } catch (error) {
                UI.showAlert('Error al crear mazo: ' + error.message, 'error');
            }
        });

        // Abrir modal editar
        function abrirModalEditar(id, nombre, serie, descripcion) {
            document.getElementById('edit-mazo-id').value = id;
            document.getElementById('edit-mazo-nombre').value = nombre;
            document.getElementById('edit-mazo-serie').value = serie;
            document.getElementById('edit-mazo-descripcion').value = descripcion;
            document.getElementById('modal-editar-mazo').style.display = 'flex';
        }

        // Cerrar modal editar
        function cerrarModalEditar() {
            document.getElementById('modal-editar-mazo').style.display = 'none';
        }

        // Form editar mazo
        document.getElementById('form-editar-mazo').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('edit-mazo-id').value;
            const mazoData = {
                nombre: document.getElementById('edit-mazo-nombre').value.trim(),
                serie: document.getElementById('edit-mazo-serie').value.trim(),
                descripcion: document.getElementById('edit-mazo-descripcion').value.trim()
            };

            try {
                const result = await API.updateMazo(id, mazoData);
                if (result.success) {
                    UI.showAlert('Mazo actualizado exitosamente', 'success');
                    cerrarModalEditar();
                    cargarMazos();
                }
            } catch (error) {
                UI.showAlert('Error al actualizar mazo: ' + error.message, 'error');
            }
        });

        // Eliminar mazo
        async function eliminarMazo(id, nombre) {
            if (!confirm(`¬øEliminar el mazo "${nombre}"? Esta acci√≥n no se puede deshacer.\n\nNOTA: No se puede eliminar si tiene partidas asociadas.`)) return;

            try {
                const result = await API.deleteMazo(id);
                if (result.success) {
                    UI.showAlert('Mazo eliminado exitosamente', 'success');
                    cargarMazos();
                    cargarResumen();
                }
            } catch (error) {
                UI.showAlert('Error: ' + error.message, 'error');
            }
        }

        // ========== GESTI√ìN DE PARTIDAS ==========

        let todasLasPartidas = [];

        // Cargar lista de partidas
        async function cargarPartidasLista() {
            const container = document.getElementById('partidas-lista-container');

            try {
                const result = await API.getPartidas();

                if (!result.success || result.partidas.length === 0) {
                    container.innerHTML = '<p class="text-center">No hay partidas registradas</p>';
                    todasLasPartidas = [];
                    return;
                }

                todasLasPartidas = result.partidas;
                renderizarPartidas(todasLasPartidas);

            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        // Renderizar tabla de partidas
        function renderizarPartidas(partidas) {
            const container = document.getElementById('partidas-lista-container');

            if (partidas.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">No se encontraron partidas</p>';
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Jugador 1</th>
                                <th>Mazo 1</th>
                                <th style="text-align: center;">VS</th>
                                <th>Jugador 2</th>
                                <th>Mazo 2</th>
                                <th>Resultado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            partidas.forEach(p => {
                const fecha = new Date(p.fecha_partida).toLocaleDateString();
                const ganador = p.ganador_nombre || 'Empate';

                html += `
                    <tr>
                        <td>${p.id}</td>
                        <td>${fecha}</td>
                        <td><strong>${p.jugador1_nombre}</strong></td>
                        <td><span class="badge badge-info">${p.mazo1_nombre}</span></td>
                        <td style="text-align: center;">‚öîÔ∏è</td>
                        <td><strong>${p.jugador2_nombre}</strong></td>
                        <td><span class="badge badge-info">${p.mazo2_nombre}</span></td>
                        <td><span class="badge ${UI.getBadgeClass(p.resultado)}">${UI.formatResultado(p.resultado)}</span></td>
                        <td>
                            <button onclick="eliminarPartida(${p.id})" class="btn btn-danger btn-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Filtrar partidas
        document.getElementById('buscar-partida').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();

            if (query === '') {
                renderizarPartidas(todasLasPartidas);
                return;
            }

            const partidasFiltradas = todasLasPartidas.filter(p =>
                p.jugador1_nombre.toLowerCase().includes(query) ||
                p.jugador2_nombre.toLowerCase().includes(query) ||
                p.mazo1_nombre.toLowerCase().includes(query) ||
                p.mazo2_nombre.toLowerCase().includes(query)
            );

            renderizarPartidas(partidasFiltradas);
        });

        // Eliminar partida
        async function eliminarPartida(id) {
            if (!confirm('¬øEliminar esta partida del historial? Esta acci√≥n no se puede deshacer.')) return;

            try {
                const result = await API.deletePartida(id);
                if (result.success) {
                    UI.showAlert('Partida eliminada exitosamente', 'success');
                    cargarPartidasLista();
                    cargarResumen();
                }
            } catch (error) {
                UI.showAlert('Error al eliminar partida: ' + error.message, 'error');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            cargarResumen();
            cargarPartidasPendientes();
            cargarSelectores();

            // Establecer fecha de hoy por defecto en el formulario de a√±adir partida
            const fechaInput = document.getElementById('fecha-partida');
            if (fechaInput) {
                const hoy = new Date().toISOString().split('T')[0];
                fechaInput.value = hoy;
            }
        });
    </script>
</body>
</html>
