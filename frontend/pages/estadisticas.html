<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Card Game Anime</title>
    <link rel="stylesheet" href="../css/global.css">
    <style>
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .tab:hover {
            background: #f3f4f6;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .comparador {
            background: #f9fafb;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .comparador-selects {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .vs-badge {
            background: var(--accent-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .resultado-comparacion {
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .mazos-usados {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .mazo-usado-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .winrate-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .winrate-box {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .winrate-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .winrate-value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .tabs {
                gap: 0.25rem;
                flex-wrap: wrap;
            }

            .tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }

            /* Filtros en m√≥vil */
            #tab-generales > div:first-child {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            #tab-generales > div:first-child h3 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            #tab-generales > div:first-child > div:first-of-type {
                grid-template-columns: 1fr !important;
            }

            #tab-generales > div:first-child > div:last-of-type {
                flex-direction: column;
                gap: 0.5rem;
            }

            #tab-generales > div:first-child > div:last-of-type button {
                width: 100%;
            }

            .comparador {
                padding: 1rem;
            }

            .comparador-selects {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .vs-badge {
                padding: 0.4rem 0.8rem;
                font-size: 1rem;
                border-radius: 8px;
                margin: 0.5rem 0;
            }

            .resultado-comparacion {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .mazos-usados {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .mazo-usado-item {
                font-size: 0.9rem;
            }

            .winrate-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1.5rem;
            }

            .winrate-box {
                padding: 0.75rem;
            }

            .winrate-label {
                font-size: 0.8rem;
            }

            .winrate-value {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Principal -->
    <header class="header-main">
        <div class="header-main-container">
            <div class="nav-brand">üé¥ Card Game Anime</div>
            <div id="user-nav"></div>
        </div>
    </header>

    <!-- Header Navegaci√≥n -->
    <nav class="header-nav">
        <div class="header-nav-container">
            <ul class="nav-links">
                <li><a href="historial.html">Historial</a></li>
                <li><a href="estadisticas.html">Estad√≠sticas</a></li>
                <li><a href="mazos.html">Mazos</a></li>
                <li><a href="combate.html">Registrar Combate</a></li>
                <li><a href="contador.html">Contador</a></li>
                <li><a href="compartir.html">üì§ Compartir</a></li>
                <li id="admin-link" style="display:none;"><a href="admin.html">Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">üìä Estad√≠sticas y Comparativas</h1>
                <p class="card-subtitle">Analiza el rendimiento de jugadores y mazos</p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('generales')">Generales</button>
                <button class="tab" onclick="cambiarTab('mazos')">Comparar Mazos</button>
                <button class="tab" onclick="cambiarTab('jugadores')">Comparar Jugadores</button>
            </div>

            <!-- Tab: Estad√≠sticas Generales -->
            <div id="tab-generales" class="tab-content active">
                <!-- Filtros -->
                <div style="background: #f9fafb; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">üîç Filtros</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Mes/A√±o</label>
                            <input type="month" id="filtro-mes" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Jugador</label>
                            <select id="filtro-jugador-stats" class="form-control">
                                <option value="">Todos los jugadores</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="limpiarFiltrosStats()" class="btn btn-secondary">Limpiar Filtros</button>
                        <button onclick="aplicarFiltrosStats()" class="btn btn-primary">Aplicar Filtros</button>
                    </div>
                </div>

                <!-- Estad√≠sticas de Jugadores -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h2 class="card-title">üë• Estad√≠sticas de Jugadores</h2>
                        <p class="card-subtitle" id="subtitle-jugadores">Winrate y r√©cord de todos los jugadores</p>
                    </div>

                    <div id="estadisticas-jugadores">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p class="mt-2">Cargando estad√≠sticas...</p>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas de Mazos -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üé¥ Estad√≠sticas de Mazos</h2>
                        <p class="card-subtitle" id="subtitle-mazos">Winrate y r√©cord de todos los mazos</p>
                    </div>

                    <div id="estadisticas-mazos">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p class="mt-2">Cargando estad√≠sticas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Comparar Mazos -->
            <div id="tab-mazos" class="tab-content">
                <div class="comparador">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-color);">‚öîÔ∏è Comparar Mazos</h3>

                    <div class="comparador-selects">
                        <select id="select-mazo1" class="form-control">
                            <option value="">Selecciona Mazo 1</option>
                        </select>
                        <div class="vs-badge">VS</div>
                        <select id="select-mazo2" class="form-control">
                            <option value="">Selecciona Mazo 2</option>
                        </select>
                    </div>

                    <button onclick="compararMazos()" class="btn btn-primary" style="width: 100%;">
                        Comparar Mazos
                    </button>
                </div>

                <div id="resultado-mazos"></div>
            </div>

            <!-- Tab: Comparar Jugadores -->
            <div id="tab-jugadores" class="tab-content">
                <div class="comparador">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-color);">üë• Comparar Jugadores</h3>

                    <div class="comparador-selects">
                        <select id="select-jugador1" class="form-control">
                            <option value="">Selecciona Jugador 1</option>
                        </select>
                        <div class="vs-badge">VS</div>
                        <select id="select-jugador2" class="form-control">
                            <option value="">Selecciona Jugador 2</option>
                        </select>
                    </div>

                    <button onclick="compararJugadores()" class="btn btn-primary" style="width: 100%;">
                        Comparar Jugadores
                    </button>
                </div>

                <div id="resultado-jugadores"></div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/searchable-select.js"></script>
    <script>
        // Mostrar link de admin si es admin
        if (API.isAdmin()) {
            document.getElementById('admin-link').style.display = 'block';
        }

        // SearchableSelects para comparaciones
        let selectMazo1, selectMazo2, selectJugador1, selectJugador2;

        // Variables globales para filtros
        let todasLasPartidas = [];
        let todosLosJugadores = [];
        let todosLosMazos = [];

        // Cambiar entre tabs
        function cambiarTab(tab) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            // Mostrar tab seleccionado
            document.getElementById(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');
        }

        // Cargar todas las partidas y llenar filtros
        async function cargarDatosIniciales() {
            try {
                // Cargar partidas
                const resultPartidas = await API.getPartidas();
                if (resultPartidas.success) {
                    todasLasPartidas = resultPartidas.partidas;
                }

                // Cargar jugadores
                const resultJugadores = await API.getUsuarios();
                if (resultJugadores.success) {
                    todosLosJugadores = resultJugadores.usuarios;

                    // Llenar select de jugadores para filtro
                    const selectJugador = document.getElementById('filtro-jugador-stats');
                    todosLosJugadores.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(jugador => {
                        const option = document.createElement('option');
                        option.value = jugador.id;
                        option.textContent = jugador.nombre;
                        selectJugador.appendChild(option);
                    });
                }

                // Cargar mazos
                const resultMazos = await API.getMazos();
                if (resultMazos.success) {
                    todosLosMazos = resultMazos.mazos;
                }

                // Cargar estad√≠sticas iniciales (sin filtros)
                cargarEstadisticasJugadores(todasLasPartidas);
                cargarEstadisticasMazos(todasLasPartidas);

            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
            }
        }

        // Aplicar filtros
        function aplicarFiltrosStats() {
            const mes = document.getElementById('filtro-mes').value;
            const jugadorId = document.getElementById('filtro-jugador-stats').value;

            let partidasFiltradas = todasLasPartidas.filter(partida => {
                // Filtro por mes
                if (mes) {
                    const fechaPartida = new Date(partida.fecha_partida);
                    const [year, month] = mes.split('-');
                    if (fechaPartida.getFullYear() !== parseInt(year) ||
                        (fechaPartida.getMonth() + 1) !== parseInt(month)) {
                        return false;
                    }
                }

                // Filtro por jugador (si el jugador particip√≥ en la partida)
                if (jugadorId) {
                    const jugadorIdInt = parseInt(jugadorId);
                    // Necesitamos obtener los IDs de los jugadores de la partida
                    // Como solo tenemos los nombres, buscaremos por nombre
                    const jugadorSeleccionado = todosLosJugadores.find(j => j.id === jugadorIdInt);
                    if (jugadorSeleccionado) {
                        if (partida.jugador1_nombre !== jugadorSeleccionado.nombre &&
                            partida.jugador2_nombre !== jugadorSeleccionado.nombre) {
                            return false;
                        }
                    }
                }

                return true;
            });

            // Actualizar subt√≠tulos
            let subtituloTexto = '';
            if (mes || jugadorId) {
                const partes = [];
                if (mes) {
                    const [year, month] = mes.split('-');
                    const fecha = new Date(year, month - 1);
                    const nombreMes = fecha.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    partes.push(nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1));
                }
                if (jugadorId) {
                    const jugadorSeleccionado = todosLosJugadores.find(j => j.id === parseInt(jugadorId));
                    if (jugadorSeleccionado) {
                        partes.push(`Jugador: ${jugadorSeleccionado.nombre}`);
                    }
                }
                subtituloTexto = `Filtrado por: ${partes.join(' - ')} (${partidasFiltradas.length} partidas)`;
            } else {
                subtituloTexto = 'Winrate y r√©cord de todos los jugadores';
            }

            document.getElementById('subtitle-jugadores').textContent = subtituloTexto;
            document.getElementById('subtitle-mazos').textContent = subtituloTexto.replace('jugadores', 'mazos');

            // Recargar estad√≠sticas con partidas filtradas
            cargarEstadisticasJugadores(partidasFiltradas);
            cargarEstadisticasMazos(partidasFiltradas);
        }

        // Limpiar filtros
        function limpiarFiltrosStats() {
            document.getElementById('filtro-mes').value = '';
            document.getElementById('filtro-jugador-stats').value = '';
            document.getElementById('subtitle-jugadores').textContent = 'Winrate y r√©cord de todos los jugadores';
            document.getElementById('subtitle-mazos').textContent = 'Winrate y r√©cord de todos los mazos';
            cargarEstadisticasJugadores(todasLasPartidas);
            cargarEstadisticasMazos(todasLasPartidas);
        }

        // Cargar estad√≠sticas de jugadores (modificada para aceptar partidas filtradas)
        function cargarEstadisticasJugadores(partidas) {
            const container = document.getElementById('estadisticas-jugadores');

            if (!partidas || partidas.length === 0) {
                container.innerHTML = `
                    <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                        No hay estad√≠sticas disponibles con los filtros seleccionados.
                    </p>
                `;
                return;
            }

            try {
                // Calcular estad√≠sticas manualmente desde partidas
                const statsJugadores = {};

                partidas.forEach(partida => {
                    // Inicializar stats para jugador1 si no existe
                    if (!statsJugadores[partida.jugador1_nombre]) {
                        statsJugadores[partida.jugador1_nombre] = {
                            nombre: partida.jugador1_nombre,
                            total_partidas: 0,
                            victorias: 0,
                            derrotas: 0,
                            empates: 0
                        };
                    }

                    // Inicializar stats para jugador2 si no existe
                    if (!statsJugadores[partida.jugador2_nombre]) {
                        statsJugadores[partida.jugador2_nombre] = {
                            nombre: partida.jugador2_nombre,
                            total_partidas: 0,
                            victorias: 0,
                            derrotas: 0,
                            empates: 0
                        };
                    }

                    // Actualizar total de partidas
                    statsJugadores[partida.jugador1_nombre].total_partidas++;
                    statsJugadores[partida.jugador2_nombre].total_partidas++;

                    // Actualizar victorias/derrotas/empates
                    if (partida.resultado === 'empate') {
                        statsJugadores[partida.jugador1_nombre].empates++;
                        statsJugadores[partida.jugador2_nombre].empates++;
                    } else if (partida.resultado === 'victoria_jugador1') {
                        statsJugadores[partida.jugador1_nombre].victorias++;
                        statsJugadores[partida.jugador2_nombre].derrotas++;
                    } else if (partida.resultado === 'victoria_jugador2') {
                        statsJugadores[partida.jugador2_nombre].victorias++;
                        statsJugadores[partida.jugador1_nombre].derrotas++;
                    }
                });

                // Convertir a array y calcular winrate
                const estadisticas = Object.values(statsJugadores).map(stat => {
                    const partidasNoEmpate = stat.total_partidas - stat.empates;
                    stat.winrate = partidasNoEmpate > 0
                        ? Math.round((stat.victorias / partidasNoEmpate) * 100)
                        : 0;
                    return stat;
                });

                // Ordenar por winrate descendente
                estadisticas.sort((a, b) => {
                    if (b.winrate !== a.winrate) {
                        return b.winrate - a.winrate;
                    }
                    return b.victorias - a.victorias;
                });

                if (estadisticas.length === 0) {
                    container.innerHTML = `
                        <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                            No hay estad√≠sticas disponibles con los filtros seleccionados.
                        </p>
                    `;
                    return;
                }

                let html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Posici√≥n</th>
                                <th>Jugador</th>
                                <th style="text-align: center;">Total Partidas</th>
                                <th style="text-align: center;">Victorias</th>
                                <th style="text-align: center;">Derrotas</th>
                                <th style="text-align: center;">Empates</th>
                                <th style="text-align: center;">Winrate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                estadisticas.forEach((stat, index) => {
                    const posicion = index + 1;
                    let medal = '';

                    if (posicion === 1) medal = 'ü•á';
                    else if (posicion === 2) medal = 'ü•à';
                    else if (posicion === 3) medal = 'ü•â';

                    const winrate = stat.winrate || 0;
                    let winrateColor = 'var(--text-secondary)';
                    if (winrate >= 70) winrateColor = 'var(--success)';
                    else if (winrate >= 50) winrateColor = 'var(--warning)';
                    else if (winrate > 0) winrateColor = 'var(--error)';

                    html += `
                        <tr>
                            <td style="font-size: 1.5rem;">${medal} ${posicion}</td>
                            <td><strong>${stat.nombre}</strong></td>
                            <td style="text-align: center;">${stat.total_partidas}</td>
                            <td style="text-align: center;"><span class="badge badge-success">${stat.victorias}</span></td>
                            <td style="text-align: center;"><span class="badge badge-error">${stat.derrotas}</span></td>
                            <td style="text-align: center;"><span class="badge badge-warning">${stat.empates}</span></td>
                            <td style="text-align: center;">
                                <strong style="color: ${winrateColor}; font-size: 1.1rem;">
                                    ${winrate}%
                                </strong>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Error al cargar estad√≠sticas: ${error.message}
                    </div>
                `;
            }
        }

        function cargarEstadisticasMazos(partidas) {
            const container = document.getElementById('estadisticas-mazos');

            if (!partidas || partidas.length === 0) {
                container.innerHTML = `
                    <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                        No hay estad√≠sticas disponibles con los filtros seleccionados.
                    </p>
                `;
                return;
            }

            try {
                // Calcular estad√≠sticas manualmente desde partidas
                const statsMazos = {};

                partidas.forEach(partida => {
                    // Inicializar stats para mazo1 si no existe
                    const mazo1Key = `${partida.mazo1_nombre}|||${partida.mazo1_serie}`;
                    if (!statsMazos[mazo1Key]) {
                        statsMazos[mazo1Key] = {
                            nombre: partida.mazo1_nombre,
                            serie: partida.mazo1_serie,
                            total_partidas: 0,
                            victorias: 0,
                            derrotas: 0,
                            empates: 0
                        };
                    }

                    // Inicializar stats para mazo2 si no existe
                    const mazo2Key = `${partida.mazo2_nombre}|||${partida.mazo2_serie}`;
                    if (!statsMazos[mazo2Key]) {
                        statsMazos[mazo2Key] = {
                            nombre: partida.mazo2_nombre,
                            serie: partida.mazo2_serie,
                            total_partidas: 0,
                            victorias: 0,
                            derrotas: 0,
                            empates: 0
                        };
                    }

                    // Actualizar total de partidas
                    statsMazos[mazo1Key].total_partidas++;
                    statsMazos[mazo2Key].total_partidas++;

                    // Actualizar victorias/derrotas/empates
                    if (partida.resultado === 'empate') {
                        statsMazos[mazo1Key].empates++;
                        statsMazos[mazo2Key].empates++;
                    } else if (partida.resultado === 'victoria_jugador1') {
                        statsMazos[mazo1Key].victorias++;
                        statsMazos[mazo2Key].derrotas++;
                    } else if (partida.resultado === 'victoria_jugador2') {
                        statsMazos[mazo2Key].victorias++;
                        statsMazos[mazo1Key].derrotas++;
                    }
                });

                // Convertir a array y calcular winrate
                const estadisticas = Object.values(statsMazos).map(stat => {
                    const partidasNoEmpate = stat.total_partidas - stat.empates;
                    stat.winrate = partidasNoEmpate > 0
                        ? Math.round((stat.victorias / partidasNoEmpate) * 100)
                        : 0;
                    return stat;
                });

                // Ordenar por winrate descendente
                estadisticas.sort((a, b) => {
                    if (b.winrate !== a.winrate) {
                        return b.winrate - a.winrate;
                    }
                    return b.victorias - a.victorias;
                });

                if (estadisticas.length === 0) {
                    container.innerHTML = `
                        <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                            No hay estad√≠sticas disponibles con los filtros seleccionados.
                        </p>
                    `;
                    return;
                }

                let html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Posici√≥n</th>
                                <th>Mazo</th>
                                <th>Serie</th>
                                <th style="text-align: center;">Total Partidas</th>
                                <th style="text-align: center;">Victorias</th>
                                <th style="text-align: center;">Derrotas</th>
                                <th style="text-align: center;">Empates</th>
                                <th style="text-align: center;">Winrate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                estadisticas.forEach((stat, index) => {
                    const posicion = index + 1;
                    let medal = '';

                    if (posicion === 1) medal = 'ü•á';
                    else if (posicion === 2) medal = 'ü•à';
                    else if (posicion === 3) medal = 'ü•â';

                    const winrate = stat.winrate || 0;
                    let winrateColor = 'var(--text-secondary)';
                    if (winrate >= 70) winrateColor = 'var(--success)';
                    else if (winrate >= 50) winrateColor = 'var(--warning)';
                    else if (winrate > 0) winrateColor = 'var(--error)';

                    html += `
                        <tr>
                            <td style="font-size: 1.5rem;">${medal} ${posicion}</td>
                            <td><strong>${stat.nombre}</strong></td>
                            <td><span class="badge badge-info">${stat.serie}</span></td>
                            <td style="text-align: center;">${stat.total_partidas}</td>
                            <td style="text-align: center;"><span class="badge badge-success">${stat.victorias}</span></td>
                            <td style="text-align: center;"><span class="badge badge-error">${stat.derrotas}</span></td>
                            <td style="text-align: center;"><span class="badge badge-warning">${stat.empates}</span></td>
                            <td style="text-align: center;">
                                <strong style="color: ${winrateColor}; font-size: 1.1rem;">
                                    ${winrate}%
                                </strong>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Error al cargar estad√≠sticas: ${error.message}
                    </div>
                `;
            }
        }

        // Cargar selectores
        async function cargarSelectores() {
            try {
                // Cargar mazos para selectores
                const resultMazos = await API.getMazos();
                const mazosOptions = resultMazos.success ? resultMazos.mazos.map(m => ({
                    id: m.id,
                    text: `${m.nombre} (${m.serie})`
                })).sort((a, b) => a.text.localeCompare(b.text)) : [];

                // Cargar jugadores para selectores
                const resultJugadores = await API.getUsuarios();
                const jugadoresOptions = resultJugadores.success ? resultJugadores.usuarios.map(u => ({
                    id: u.id,
                    text: u.nombre
                })).sort((a, b) => a.text.localeCompare(b.text)) : [];

                // Inicializar SearchableSelects para mazos
                selectMazo1 = new SearchableSelect(document.getElementById('select-mazo1'), {
                    options: mazosOptions,
                    placeholder: 'Selecciona Mazo 1',
                    searchPlaceholder: 'Buscar mazo...',
                    onChange: () => compararMazos()
                });

                selectMazo2 = new SearchableSelect(document.getElementById('select-mazo2'), {
                    options: mazosOptions,
                    placeholder: 'Selecciona Mazo 2',
                    searchPlaceholder: 'Buscar mazo...',
                    onChange: () => compararMazos()
                });

                // Inicializar SearchableSelects para jugadores
                selectJugador1 = new SearchableSelect(document.getElementById('select-jugador1'), {
                    options: jugadoresOptions,
                    placeholder: 'Selecciona Jugador 1',
                    searchPlaceholder: 'Buscar jugador...',
                    onChange: () => compararJugadores()
                });

                selectJugador2 = new SearchableSelect(document.getElementById('select-jugador2'), {
                    options: jugadoresOptions,
                    placeholder: 'Selecciona Jugador 2',
                    searchPlaceholder: 'Buscar jugador...',
                    onChange: () => compararJugadores()
                });

            } catch (error) {
                console.error('Error cargando selectores:', error);
            }
        }

        // Comparar Mazos
        async function compararMazos() {
            const mazo1_id = selectMazo1?.getValue();
            const mazo2_id = selectMazo2?.getValue();
            const container = document.getElementById('resultado-mazos');

            if (!mazo1_id || !mazo2_id) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Por favor selecciona ambos mazos.
                    </div>
                `;
                return;
            }

            if (mazo1_id === mazo2_id) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Por favor selecciona mazos diferentes.
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="mt-2">Comparando mazos...</p>
                </div>
            `;

            try {
                const result = await API.compararMazos(mazo1_id, mazo2_id);

                if (!result.success) {
                    container.innerHTML = `
                        <div class="alert alert-error">
                            ${result.message}
                        </div>
                    `;
                    return;
                }

                const { mazo1, mazo2, estadisticas, partidas } = result;

                let html = `
                    <div class="resultado-comparacion">
                        <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 2rem;">
                            ${mazo1.nombre} <span style="color: var(--accent-color);">VS</span> ${mazo2.nombre}
                        </h3>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Partidas</div>
                                <div class="stat-value">${estadisticas.total_partidas}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">${mazo1.nombre} Victorias</div>
                                <div class="stat-value" style="color: var(--success);">${estadisticas.mazo1_victorias}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">${mazo2.nombre} Victorias</div>
                                <div class="stat-value" style="color: var(--error);">${estadisticas.mazo2_victorias}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Empates</div>
                                <div class="stat-value" style="color: var(--warning);">${estadisticas.empates}</div>
                            </div>
                        </div>

                        <div class="winrate-grid">
                            <div class="winrate-box">
                                <div class="winrate-label">
                                    Winrate ${mazo1.nombre}
                                </div>
                                <div class="winrate-value" style="color: var(--success);">
                                    ${estadisticas.mazo1_winrate}%
                                </div>
                            </div>
                            <div class="winrate-box">
                                <div class="winrate-label">
                                    Winrate ${mazo2.nombre}
                                </div>
                                <div class="winrate-value" style="color: var(--error);">
                                    ${estadisticas.mazo2_winrate}%
                                </div>
                            </div>
                        </div>
                `;

                if (partidas.length > 0) {
                    html += `
                        <h4 style="margin-bottom: 1rem;">Historial de Enfrentamientos</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Jugador 1</th>
                                    <th>Mazo 1</th>
                                    <th style="text-align: center;">VS</th>
                                    <th>Jugador 2</th>
                                    <th>Mazo 2</th>
                                    <th>Resultado</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    partidas.forEach(p => {
                        const fecha = UI.formatDate(p.fecha_partida);
                        const badgeClass = UI.getBadgeClass(p.resultado);

                        html += `
                            <tr>
                                <td>${fecha}</td>
                                <td>${p.jugador1_nombre}</td>
                                <td><span class="badge badge-info">${p.mazo1_nombre}</span></td>
                                <td style="text-align: center;">‚öîÔ∏è</td>
                                <td>${p.jugador2_nombre}</td>
                                <td><span class="badge badge-info">${p.mazo2_nombre}</span></td>
                                <td><span class="badge ${badgeClass}">${UI.formatResultado(p.resultado)}</span></td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                    `;
                } else {
                    html += `
                        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Estos mazos nunca se han enfrentado.
                        </p>
                    `;
                }

                html += `</div>`;
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Error al comparar mazos: ${error.message}
                    </div>
                `;
            }
        }

        // Comparar Jugadores
        async function compararJugadores() {
            const jugador1_id = selectJugador1?.getValue();
            const jugador2_id = selectJugador2?.getValue();
            const container = document.getElementById('resultado-jugadores');

            if (!jugador1_id || !jugador2_id) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Por favor selecciona ambos jugadores.
                    </div>
                `;
                return;
            }

            if (jugador1_id === jugador2_id) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Por favor selecciona jugadores diferentes.
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="mt-2">Comparando jugadores...</p>
                </div>
            `;

            try {
                const result = await API.compararJugadores(jugador1_id, jugador2_id);

                if (!result.success) {
                    container.innerHTML = `
                        <div class="alert alert-error">
                            ${result.message}
                        </div>
                    `;
                    return;
                }

                const { jugador1, jugador2, estadisticas, mazosUsados, partidas } = result;

                let html = `
                    <div class="resultado-comparacion">
                        <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 2rem;">
                            ${jugador1.nombre} <span style="color: var(--accent-color);">VS</span> ${jugador2.nombre}
                        </h3>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Partidas</div>
                                <div class="stat-value">${estadisticas.total_partidas}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">${jugador1.nombre} Victorias</div>
                                <div class="stat-value" style="color: var(--success);">${estadisticas.jugador1_victorias}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">${jugador2.nombre} Victorias</div>
                                <div class="stat-value" style="color: var(--error);">${estadisticas.jugador2_victorias}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Empates</div>
                                <div class="stat-value" style="color: var(--warning);">${estadisticas.empates}</div>
                            </div>
                        </div>

                        <div class="winrate-grid">
                            <div class="winrate-box">
                                <div class="winrate-label">
                                    Winrate ${jugador1.nombre}
                                </div>
                                <div class="winrate-value" style="color: var(--success);">
                                    ${estadisticas.jugador1_winrate}%
                                </div>
                            </div>
                            <div class="winrate-box">
                                <div class="winrate-label">
                                    Winrate ${jugador2.nombre}
                                </div>
                                <div class="winrate-value" style="color: var(--error);">
                                    ${estadisticas.jugador2_winrate}%
                                </div>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 1rem;">Mazos Utilizados</h4>
                        <div class="mazos-usados">
                            <div>
                                <h5 style="color: var(--primary-color); margin-bottom: 1rem;">${jugador1.nombre}</h5>
                `;

                Object.entries(mazosUsados.jugador1).forEach(([mazo, veces]) => {
                    html += `
                        <div class="mazo-usado-item">
                            <span>${mazo}</span>
                            <span class="badge badge-info">${veces}x</span>
                        </div>
                    `;
                });

                html += `
                            </div>
                            <div>
                                <h5 style="color: var(--primary-color); margin-bottom: 1rem;">${jugador2.nombre}</h5>
                `;

                Object.entries(mazosUsados.jugador2).forEach(([mazo, veces]) => {
                    html += `
                        <div class="mazo-usado-item">
                            <span>${mazo}</span>
                            <span class="badge badge-info">${veces}x</span>
                        </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                `;

                if (partidas.length > 0) {
                    html += `
                        <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Historial de Enfrentamientos</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Jugador 1</th>
                                    <th>Mazo 1</th>
                                    <th style="text-align: center;">VS</th>
                                    <th>Jugador 2</th>
                                    <th>Mazo 2</th>
                                    <th>Resultado</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    partidas.forEach(p => {
                        const fecha = UI.formatDate(p.fecha_partida);
                        const badgeClass = UI.getBadgeClass(p.resultado);

                        html += `
                            <tr>
                                <td>${fecha}</td>
                                <td>${p.jugador1_nombre}</td>
                                <td><span class="badge badge-info">${p.mazo1_nombre}</span></td>
                                <td style="text-align: center;">‚öîÔ∏è</td>
                                <td>${p.jugador2_nombre}</td>
                                <td><span class="badge badge-info">${p.mazo2_nombre}</span></td>
                                <td><span class="badge ${badgeClass}">${UI.formatResultado(p.resultado)}</span></td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                    `;
                } else {
                    html += `
                        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Estos jugadores nunca se han enfrentado.
                        </p>
                    `;
                }

                html += `</div>`;
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        Error al comparar jugadores: ${error.message}
                    </div>
                `;
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatosIniciales();
            cargarSelectores();
        });
    </script>
</body>
</html>
